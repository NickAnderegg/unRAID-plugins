Menu="IPMI:1"
Title="Settings"
---
<? require_once '/usr/local/emhttp/plugins/ipmi/include/ipmi_settings.php'; ?>
<link type="text/css" rel="stylesheet" href="/plugins/ipmi/css/ipmi.css">
<script type="text/javascript" src="/plugins/ipmi/js/jquery.mask.js"></script>

<div id="title" style="margin-top: -22px;">
	<span class="left"><img class="icon" src="/plugins/ipmi/icons/ipmi.png"> IPMI Settings</span>
	<span class="status" style="margin-top: 50px;margin-left: -200px;">
	<img class="board-img" src=""></span>
	<span class="status" id="notify-status">Event Notification: <?=$seld_status;?> </span>
</div>

<form markdown="1" name="seld_settings" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" name="#file" value="ipmi/ipmi.cfg" />
<input type="hidden" id="COMMAND" name="#command" value="" />

Enable Event Notifications:
: <select id="IPMISELD" name="IPMISELD" size="1" onChange="checkSELD(this.form);" title="Enable event notifications and local system logging for ipmi events">
  <?=mk_option($seld, "disable", "No");?>
  <?=mk_option($seld, "enable", "Yes");?>
  </select> &nbsp; <input id="btnTest" type="button" value="Test" title="send a random sample event to your ipmi hardware">
<blockquote class="inline_help">
	<p>Enable IPMI event notifications. IPMI events will be logged in the system log.  System log is monitored and notification event sent based on severity.</p>
</blockquote>

Event Polling Time:
: <select id="IPMIPOLL" class="seld-run" name="IPMIPOLL" size="1" title="Amount of time between ipmi event log checks">
  <?=mk_option($seldpoll, '15', '15 sec');?>
  <?=mk_option($seldpoll, '30', '30 sec');?>
  <?=mk_option($seldpoll, '60', '1 min');?>
  <?=mk_option($seldpoll, '180', '3 min');?>
  <?=mk_option($seldpoll, '300', '5 min');?>
  <?=mk_option($seldpoll, '1800', '30 min');?>
  </select>
<blockquote class="inline_help">
	<p>Specify how long between checking IPMI event log and adding events to system log. </p>
</blockquote>

Enable Network Connection(s):
: <select id="NETWORK" class="seld-run" name="NETWORK" size="1" onChange="checkNETWORK(this.form);"  title="Enable connection to network based ipmi, not necessary for local onboard ipmi">
  <?=mk_option($netsvc, 'disable', 'No');?>
  <?=mk_option($netsvc, 'enable', 'Yes');?>
  </select>
<blockquote class="inline_help">
	<p>Enable monitoring of IPMI sensors and events through the network.</p>
</blockquote>

<label class="seld-run ipmi-lan">Enable Localhost Connection:</label>
: <select id="LOCAL" class="seld-run ipmi-lan" name="LOCAL" size="1" onChange="checkLOCAL(this.form);" title="Enable localhost connection along with network connections">
  <?=mk_option($local, 'disable', 'No');?>
  <?=mk_option($local, 'enable', 'Yes');?>
  </select>
<blockquote class="inline_help">
	<p>Enable monitoring of localhost as well as network servers. Useful when monitoring local server as well as a backup server or two.</p>
</blockquote>

<label class="seld-run ipmi-lan">IPMI IP Address(es):</label>
: <input id="IPADDR" type="text" class="seld-run ipmi-lan ipmi-ipaddr" name="IPADDR" maxlength="66" value="<?=$ipaddr;?>" title="IPMI IP address" placeholder="" ><label class='ipmi-lan'><?=$conn;?></label>
<blockquote class="inline_help">
	<p>Add up to four different IPMI IP addresses to monitor sensors and events.</p>
</blockquote>

<label class="seld-run ipmi-lan">IPMI User Name:</label>
: <input id="USER" type="text" class="seld-run ipmi-lan ipmi-user" name="USER" maxlength="40" value="<?=$user;?>" title="username for network access IPMI" placeholder="username for network access" >
<blockquote class="inline_help">
	<p>Username for IPMI connections(s).</p>
</blockquote>

<label class="seld-run ipmi-lan">IPMI Password:</label>
: <input id="PASSWORD" type="password" class="seld-run ipmi-lan ipmi-password" name="PASSWORD" maxlength="40" value="<?=$password;?>" title="password for network access IPMI" placeholder="password for network access" >
<blockquote class="inline_help">
	<p>Password for IPMI connection(s).</p>
</blockquote>

&nbsp;

<input id="DEFAULT" class="seld-run" type="button" value="Default" onClick="resetDATA(this.form);"><input type="button" value="Readings" onClick="javascript:location.href='/Tools/IPMITools'" title="go to readings and events page">
: <input type="button" id="edit" value="Edit" title="edit IPMI configuration"><input id="btnApply" type="submit" value="Apply" onClick="verifyDATA(this.form)"><input type="button" value="Done" onClick="done()">
</form>
<blockquote class="inline_help">
	<p>Default button resets form.  Readings button redirects to sensor readings and events on the Tools page</p>
</blockquote>

<div id="title"><span class="left"><img class="icon" src="/plugins/ipmi/icons/mb.png"> Display Settings</span></div>

<form markdown="1" name="footer_settings" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" name="#file" value="ipmi/ipmi.cfg" />
<blockquote class="inline_help">
	<p>Display Settings can be applied at any time.</p>
</blockquote>

Sensor #1:
: <select name="DISP_SENSOR1" class="display">
		<option value='false'>None</option>
		<?=ipmi_get_options($disp_sensor1);?>
  </select>
<blockquote class="inline_help">
	<p>First sensor to monitor and display in footer of webGui.</p>
</blockquote>

Sensor #2:
: <select name="DISP_SENSOR2" class="display">
		<option value='false'>None</option>
		<?=ipmi_get_options($disp_sensor2);?>
	</select>
<blockquote class="inline_help">
	<p>Second sensor to monitor and display in footer of webGui.</p>
</blockquote>

Sensor #3:
: <select name="DISP_SENSOR3" class="display">
		<option value='false'>None</option>	
		<?=ipmi_get_options($disp_sensor3);?>
	</select>
<blockquote class="inline_help">
	<p>Third sensor to monitor and display in footer of webGui.</p>
</blockquote>

Sensor #4:
: <select name="DISP_SENSOR4" class="display">
		<option value='false'>None</option>
		<?=ipmi_get_options($disp_sensor4);?>
	</select>
<blockquote class="inline_help">
	<p>Forth sensor to monitor and display in footer of webGui.</p>
</blockquote>

&nbsp;
: <input type="submit" value="Apply"><input type="button" value="Done" onClick="done()">
</form>

<script>
$(function(){
	$('.tabs')
		.append("<span class='status settings'><label id='bmc-reset' title='warm reset bmc'><i class='fa fa-refresh'></i> Reset BMC </label></span>");

	<?if (function_exists('plugin_update_available') && $version = plugin_update_available('ipmi')):?>
		showNotice('IPMI <?=$version?> is available. <a>Download Now</a>','ipmi');
	<?endif;?>

	$('#edit').click(function() {
		location = '/Settings/IPMIEditor';
	});

	// if png is missing, replaced with unknown.png
	$('.board-img')
		.error(function() {
			$('.board-img').attr('src', '/plugins/ipmi/images/unknown.png');
		})
		.attr('src', "/plugins/ipmi/images/<?=$board;?>.png");

	$('#bmc-rest').on('click', resetBMC);
	
	$('#btnTest').on('click', EventTest);

	checkSELD(document.seld_settings);
	checkNETWORK(document.seld_settings);
	checkLOCAL(document.seld_settings);
	decData(document.seld_settings);
});

function resetDATA(form) {
	form.IPMIPOLL.selectedIndex = 2;
	form.NETWORK.selectedIndex = 0;
	form.LOCAL.selectedIndex = 0;
	form.IPADDR.value = '';
	form.USER.value = '';
	form.PASSWORD.value = '';
	form.DISP_TEMP1.selectedIndex = 0;
	form.DISP_TEMP2.selectedIndex = 0;
	form.DISP_FAN1.selectedIndex = 0;
	form.DISP_FAN2.selectedIndex = 0;
	form.submit();
}

function checkSELD(form) {
	if (form.IPMISELD.selectedIndex < 1 ){
		form.COMMAND.value = '/usr/local/emhttp/plugins/ipmi/scripts/seld_stop';
		$('#btnApply').prop('disabled', false);
	}else {
   	form.COMMAND.value = '/usr/local/emhttp/plugins/ipmi/scripts/seld_start';
   }

	if ("<?=$seld_run;?>" == true)
	{
		$('.seld-run').prop('disabled', true);
		$('#btnApply').disabled = 'disabled';
		$('#btnTest').show();
   }else{
   	$('.seld-run').prop('disabled', false);
		$('#btnApply').prop('disabled', false);
		$('#btnTest').hide();
	}
}

function decData(form) {
 form.PASSWORD.value = atob(form.PASSWORD.value);
}

function checkNETWORK(form) {
	if (form.NETWORK.selectedIndex < 1 )
		$('.ipmi-lan').hide();
	else {
   	$('.ipmi-lan').show();
   	$('.ipmi-lan').prop('disabled', (form.IPMISELD.value == 'enable'));
   }
}

function checkLOCAL(form) {
	if (form.LOCAL.selectedIndex < 1 ){
		$('.ipmi-ipaddr').mask('0ZZ.0ZZ.0ZZ.0ZZ,0ZZ.0ZZ.0ZZ.0ZZ,0ZZ.0ZZ.0ZZ.0ZZ,0ZZ.0ZZ.0ZZ.0ZZ', {translation:  {'Z': {pattern: /[0-9]/, optional: true}}});
	}else{ 
		$('.ipmi-ipaddr').mask('localhost,0ZZ.0ZZ.0ZZ.0ZZ,0ZZ.0ZZ.0ZZ.0ZZ,0ZZ.0ZZ.0ZZ.0ZZ', {translation:  {'Z': {pattern: /[0-9]/, optional: true}}});
	}
}

function verifyDATA(form) {
	form.IPMISELD.value = form.IPMISELD.value.replace(/ /g,'_');
	form.NETWORK.value = form.NETWORK.value.replace(/ /g,'_');
	form.USER.value = form.USER.value.replace(/ /g,'_');
	form.PASSWORD.value = btoa(form.PASSWORD.value);
}


function EventTest() {
	$.getJSON('/plugins/ipmi/include/ipmi_event_test.php',
		function(Message) {
		swal({
			title: 'Sample Event Sent:', 
			text: Message, 
			type: 'success',
			showCancelButton: false,
			closeOnConfirm: true,
		}, function() {
		});
	});
}

function resetBMC(){
	$.get('/plugins/ipmi/include/bmc_reset.php', {},function() {
	});
};

</script>